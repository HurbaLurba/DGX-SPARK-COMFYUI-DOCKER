---
- name: Rebuild sageattention from source for Blackwell sm_121
  hosts: spark_primary
  become: yes

  tasks:
    - name: Stop ComfyUI service if running
      systemd:
        name: "{{ service_name }}"
        state: stopped
      ignore_errors: yes

    - name: Uninstall existing sageattention (prebuilt wheel without sm_121)
      shell: |
        source {{ venv_path }}/bin/activate
        {{ venv_path }}/bin/pip uninstall -y sageattention
      args:
        executable: /bin/bash
      ignore_errors: yes

    - name: Install git (required for source build)
      apt:
        name: git
        state: present
        update_cache: yes

    - name: Clone sageattention from source
      git:
        repo: "https://github.com/thu-ml/sageattention.git"
        dest: "/tmp/sageattention"
        version: "main"
        force: yes

    - name: Build and install sageattention from source with sm_121 support
      shell: |
        set -e
        
        # Set all environment variables for build
        {% for key, value in comfyui_env_vars.items() %}
        export {{ key }}="{{ value }}"
        {% endfor %}
        
        # Set CUDA compilation environment
        export CUDA_HOME="{{ cuda_home }}"
        export TORCH_CUDA_ARCH_LIST="{{ cuda_arch_list }}"
        export PATH="{{ venv_path }}/bin:{{ cuda_home }}/bin:/usr/bin:/bin:/usr/local/bin:$PATH"
        export CC=/usr/bin/gcc
        export CXX=/usr/bin/g++
        export AS=/usr/bin/as
        
        echo "========================================"
        echo "Building sageattention from source for sm_121"
        echo "CUDA_HOME: $CUDA_HOME"
        echo "TORCH_CUDA_ARCH_LIST: $TORCH_CUDA_ARCH_LIST"
        echo "Source directory: /tmp/sageattention"
        echo "Using python: {{ venv_path }}/bin/python"
        echo "Using pip: {{ venv_path }}/bin/pip"
        echo "========================================"
        
        cd /tmp/sageattention
        
        # Build CUDA kernels explicitly with setup.py
        echo "Step 1: Building CUDA kernels with setup.py..."
        MAX_JOBS=4 {{ venv_path }}/bin/python setup.py build_ext --inplace
        
        # Create wheel with compiled kernels
        echo "Step 2: Creating wheel with compiled kernels..."
        MAX_JOBS=4 {{ venv_path }}/bin/python setup.py bdist_wheel
        
        # Install the built wheel
        echo "Step 3: Installing built wheel..."
        {{ venv_path }}/bin/pip install dist/*.whl --force-reinstall
        
        echo "========================================"
        echo "Verifying sageattention installation"
        echo "========================================"
        
        {{ venv_path }}/bin/python -c "import sageattention; print('✓ sageattention successfully imported from source build!')"
        
        echo "✓ sageattention built from source with sm_{{ cuda_arch_list | replace('.', '') }} kernels!"
      args:
        executable: /bin/bash
      register: sage_build_result

    - name: Display build output
      debug:
        msg: "{{ sage_build_result.stdout_lines }}"

    - name: Start ComfyUI service
      systemd:
        name: "{{ service_name }}"
        state: started
        enabled: yes

    - name: Wait for ComfyUI to start
      wait_for:
        host: 127.0.0.1
        port: "{{ service_port }}"
        delay: 5
        timeout: 60

    - name: Display completion message
      debug:
        msg: |
          ========================================
          Sageattention rebuilt from source!
          ========================================
          
          Built with compute capability: sm_{{ cuda_arch_list | replace('.', '') }}
          Source: https://github.com/thu-ml/sageattention
          
          Sageattention is now compiled with Blackwell sm_121 kernels.
          
          Verify in logs:
            sudo journalctl -u comfyui -n 50 | grep -i sage
          
          You should see: "Using sage attention"
          
          Test a video generation workflow to verify sm_121 kernels load correctly.
